name: Build & Deploy

on:
    pull_request:
        branches:
            - main
            - develop
            - uat
        types:
            - closed
    workflow_dispatch:

permissions:
    contents: read

jobs:
    build_and_push:
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Detect changed files
              id: changed
              run: |
                  echo "üîé Detecting changed files..."
                  CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }})
                  echo "$CHANGED_FILES" > changed_files.txt
                  echo "Changed files:"
                  cat changed_files.txt

            - name: Detect changed services
              id: services
              run: |
                  SERVICES=""
                  while read file; do
                    DIR=$(dirname "$file")
                    # Walk up to find Dockerfile
                    while [ "$DIR" != "." ] && [ "$DIR" != "/" ]; do
                      if [ -f "$DIR/Dockerfile" ]; then
                        SERVICES="$SERVICES $DIR"
                        break
                      fi
                      DIR=$(dirname "$DIR")
                    done
                  done < changed_files.txt
                  # Remove duplicates
                  SERVICES=$(echo $SERVICES | tr ' ' '\n' | sort -u)
                  echo "Changed services: $SERVICES"
                  echo "services=$SERVICES" >> $GITHUB_OUTPUT

            - name: Build and push changed services
              if: ${{ steps.services.outputs.services != '' }}
              run: |
                  BRANCH="${{ github.base_ref }}"
                  declare -A VERSION_MAP=( ["main"]="prod" ["uat"]="uat" ["develop"]="dev" )
                  declare -A BASE_PATH_MAP=( ["main"]="" ["uat"]="/uat" ["develop"]="/dev" )

                  for SERVICE_DIR in ${{ steps.services.outputs.services }}; do
                    IMAGE_NAME="cp25ms1/${SERVICE_DIR##*/}"
                    IMAGE_VERSION=${VERSION_MAP[$BRANCH]}
                    BUILD_ARGS="BASE_PATH=${BASE_PATH_MAP[$BRANCH]}"

                    echo "üîπ Building and pushing $SERVICE_DIR ‚Üí $IMAGE_NAME:$IMAGE_VERSION"
                    docker login -u cp25ms1 -p ${{ secrets.DOCKERHUB_TOKEN }}
                    docker build -t $IMAGE_NAME:$IMAGE_VERSION --build-arg $BUILD_ARGS $SERVICE_DIR
                    docker push $IMAGE_NAME:$IMAGE_VERSION
                  done

            - name: No services changed
              if: ${{ steps.services.outputs.services == '' }}
              run: |
                  echo "‚ö†Ô∏è No changed services detected ‚Äî nothing to build."
