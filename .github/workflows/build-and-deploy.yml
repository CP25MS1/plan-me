name: Build & Deploy

on:
  pull_request:
    branches:
      - main
      - develop
      - uat
    types:
      - closed
  workflow_dispatch:
    inputs:
      build_all:
        description: 'Build all services regardless of changes'
        required: false
        default: 'false'

permissions:
  contents: read

jobs:
  build_and_push:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        id: changed
        run: |
          echo "üîé Detecting changed files..."
          rm -f changed_files.txt || true

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.build_all }}" = "true" ]; then
            echo "‚ö° Manual trigger with build_all=true ‚Äî listing all Dockerfiles"
            find . -name Dockerfile -exec dirname {} \; | tr '\n' ' ' | xargs > changed_files.txt
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "Event: pull_request ‚Äî using base/head SHAs"
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            git fetch --no-tags --prune origin "$BASE_SHA" "$HEAD_SHA" || true
            git diff --name-only "$BASE_SHA" "$HEAD_SHA" > changed_files.txt || true
          else
            echo "Event: ${{ github.event_name }} ‚Äî fallback to HEAD~1..HEAD diff"
            git fetch --no-tags --prune --unshallow || true
            git diff --name-only HEAD~1 HEAD > changed_files.txt || true
          fi

          echo "Changed files:"
          cat changed_files.txt || true
          CHANGED=$(tr '\n' ' ' < changed_files.txt | xargs || true)
          echo "changed_files=$CHANGED" >> $GITHUB_OUTPUT

      - name: Detect changed services
        id: services
        run: |
          echo "üîé Detecting services..."
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.build_all }}" = "true" ]; then
            # Manual run with build_all=true: include all services
            SERVICES=$(find . -name Dockerfile -exec dirname {} \; | sort -u | tr '\n' ' ' | xargs)
          else
            SERVICES=""
            while IFS= read -r file || [ -n "$file" ]; do
              [ -z "$file" ] && continue
              DIR=$(dirname "$file")
              while [ "$DIR" != "." ] && [ "$DIR" != "/" ]; do
                if [ -f "$DIR/Dockerfile" ]; then
                  SERVICES="$SERVICES $DIR"
                  break
                fi
                DIR=$(dirname "$DIR")
              done
            done < changed_files.txt
            SERVICES=$(echo $SERVICES | tr ' ' '\n' | sed '/^$/d' | sort -u | tr '\n' ' ' | xargs || true)
          fi
          echo "Changed services: $SERVICES"
          echo "services=$SERVICES" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        if: ${{ steps.services.outputs.services != '' }}
        uses: docker/login-action@v2
        with:
          username: cp25ms1
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push services
        if: ${{ steps.services.outputs.services != '' }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.event.pull_request.base.ref }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi

          declare -A VERSION_MAP=( ["main"]="prod" ["uat"]="uat" ["develop"]="dev" )
          declare -A BASE_PATH_MAP=( ["main"]="" ["uat"]="/uat" ["develop"]="/dev" )

          SERVICES="${{ steps.services.outputs.services }}"

          for SERVICE_DIR in $SERVICES; do
            IMAGE_NAME="cp25ms1/${SERVICE_DIR##*/}"
            IMAGE_VERSION=${VERSION_MAP[$BRANCH]}
            BUILD_ARGS="BASE_PATH=${BASE_PATH_MAP[$BRANCH]}"

            echo "üîπ Building and pushing $SERVICE_DIR ‚Üí $IMAGE_NAME:$IMAGE_VERSION"
            docker build -t $IMAGE_NAME:$IMAGE_VERSION --build-arg $BUILD_ARGS $SERVICE_DIR
            docker push $IMAGE_NAME:$IMAGE_VERSION
          done

      - name: No services changed
        if: ${{ steps.services.outputs.services == '' }}
        run: |
          echo "‚ö†Ô∏è No changed services detected ‚Äî nothing to build."
